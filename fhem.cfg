attr global userattr cmdIcon devStateIcon devStateStyle fp_byt icon sortby webCmd webCmdLabel:textField-long widgetOverride
attr global autoload_undefined_devices 1
attr global autosave 0
attr global logfile ./log/fhem-%Y-%m.log
attr global modpath .
attr global motd SecurityCheck:\
  WEBlocal8087 is not password protected\
  WEBglobal8084 is not password protected\
  WEBlocal8086 is not password protected\
  WEBlocal8088 is not password protected\
  WEBglobal8085 is not password protected\
\
Protect this FHEM installation by configuring the allowed device allowed_WEB\
You can disable this message with attr global motd none
attr global sendStatistics onUpdate
attr global statefile ./log/fhem.save
attr global updateInBackground 0
attr global verbose 3

define telnetPort telnet 7072 global
define allowed_telnetPort allowed
attr allowed_telnetPort password Averbuch
attr allowed_telnetPort validFor telnetPort

###attr global sslVersion SSLv23:!SSLv3:!SSLv2

define WEB FHEMWEB 8083 global
attr WEB HTTPS 1
attr WEB editConfig 1
attr WEB hiddenroom DashboardRoom
attr WEB room web
###attr WEB HTTPS 1
define allowed_WEB allowed
attr allowed_WEB basicAuth dGx1c3RvY2g6QXZlcmJ1Y2g=
attr allowed_WEB validFor WEB
#attr WEB verbose 5

define WEBglobal8084 FHEMWEB 8084 global
attr WEBglobal8084 HTTPS 1
attr WEBglobal8084 hiddenroom DashboardRoom
attr WEBglobal8084 room web
attr WEBglobal8084 smallscreenCommands 1
attr WEBglobal8084 stylesheetPrefix smallscreen
define allowed_WEBphone allowed
attr allowed_WEBphone basicAuth dGx1c3RvY2g6QXZlcmJ1Y2g=
attr allowed_WEBphone validFor WEBphone

define WEBglobal8085 FHEMWEB 8085 global
attr WEBglobal8085 HTTPS 1
attr WEBglobal8085 hiddenroom DashboardRoom
attr WEBglobal8085 room web
attr WEBglobal8085 stylesheetPrefix touchpad
define allowed_WEBtablet allowed
attr allowed_WEBtablet basicAuth dGx1c3RvY2g6QXZlcmJ1Y2g=
attr allowed_WEBtablet validFor WEBtablet


define WEBlocal8086 FHEMWEB 8086 global
attr WEBlocal8086 defaultRoom domov
attr WEBlocal8086 hiddenroom DashboardRoom
attr WEBlocal8086 refresh 60
attr WEBlocal8086 room web

define WEBlocal8087 FHEMWEB 8087 global
attr WEBlocal8087 defaultRoom domov
attr WEBlocal8087 room web
attr WEBlocal8087 smallscreenCommands 1
attr WEBlocal8087 stylesheetPrefix smallscreen


# Fake FileLog entry, to access the fhem log from FHEMWEB 
define Logfile FileLog ./log/fhem-%Y-%m.log fakelog


define eventTypes eventTypes ./log/eventTypes.txt

# Disable this to avoid looking for new USB devices on startup
# define initialUsbCheck notify global:INITIALIZED usb create

define CENTRALA notify CENTRALA_AT:.* { \
    Log 3, "$SELF:$NAME=$EVENT";;;;\
	### read device and reading names from CENTRALA attributes\
	# valve actuators\
	my $currentActReading = AttrVal($SELF, "valveCurrentActReadingName", "pos_tx");;;; # GET current  actuation reading name on the actor_device(s)\
	my $setActCmd 	      = AttrVal($SELF, "valveSetActCmd", "fht_pos_percent");;;;    # SET required actuation command name on the actor_device(s)\
	my $idleCmd     	  = AttrVal($SELF, "valveIdleCmd", "fht_idle");;;; # optional idle command (keep-alive msg to be sent instead of SET when no change is needed)\
	# boiler\
	my $boilerDevice 	  = AttrVal($SELF, "boilerDevice", "MYSENSOR_KOTEL");;;;\
	my $boilerSetReading  = AttrVal($SELF, "boilerSetReadingName", "percentage1");;;; # "status1"\
	my $boilerActTreshold = AttrVal($SELF, "boilerActTreshold", "0");;;; \
	my $boilerOTStatusReadingName = AttrVal($SELF, "boilerOTStatusReadingName", "NA");;;; # \
	# equitherm device (optional)\
	my $equithermDevice   = AttrVal($SELF, "EquithermDevice", "NA");;;;\
	my $equithermReading  = AttrVal($SELF, "EquithermReadingName", "NA");;;;	\
	# CENTRALA readings\
	my $acts_str 		  = AttrVal($SELF, "actList", "");;;; # space separated list <CENTRALA_req_act_reading>,<actor_device>,<weight>[space]...\
	\
	### parse data and sum all actuations (required and current)\
	my @acts = split(' ', $acts_str);;;; # space separated\
	my @T;;;;\
	my $i=0;;;;\
	my $sum_req = 0;;;;  # required actuations (weighted sum)\
	my $sum_cur = 0;;;;  # current actuations (weighted sum)\
	my $sum_safe = 0;;;; # minima of possible actuations (the worst value in boiler pump safety considerations)\
	for my $a (@acts) {\
	    # parse single actList atribute item (comma separated)\
		my @s =  split(/,/, $a);;;; # comma separated\
		my $req_name = $s[0];;;; # CENTRALA required actuation reading name\
		my $act_dev  = $s[1];;;; # actor device name\
		my $pid_dev  = $s[2];;;; # pid device name   \
		my $weight   = $s[3];;;; # actor weight\
		my $shift    = $s[4];;;; # actor shift\
		# parse required actuation\
		my $req_val = ReadingsVal($pid_dev, "actuation", 0);;;; # bounded by PID20\
		my $req_cal = sprintf "%.0f", ReadingsVal($pid_dev, "actuationCalc", 0);;;; # round calculated (unbounded, +-) required actuation\
		fhem("setreading $SELF $req_name $req_val,$req_cal+$shift");;;;\
		# parse remaining readings\
		my $cur_val = ReadingsVal($act_dev, $currentActReading, 0);;;; # current (last known) actuation\
		my $safe_val = min ($req_val, $cur_val);;;;\
		# remember all parsed values\
		$T[$i++] = { \
			'req_name' => $req_name, \
			'act_dev'  => $act_dev, \
			'pid_dev'  => $pid_dev, 			\
			'weight'   => $weight,\
			'shift'    => $shift,\
			'req_val'  => max (0, $req_cal), # $req_val may be forced to pidActorErrorPos \
			'req_cal'  => $req_cal,\
			'cur_val'  => $cur_val,\
			'safe_val' => $safe_val};;;;\
		# update sums\
		$sum_req += $weight*$req_val;;;;\
		$sum_cur += $weight*$cur_val;;;;\
		$sum_safe += $weight*$safe_val;;;;\
\
		Log 3, "$SELF: $req_name req=$weight*$req_val, cur=$weight*$cur_val, safe=$weight*$safe_val";;;;\
	};;;; \
	\
	### we have the final sum\
	fhem ("setreading $SELF sum_req $sum_req");;;; \
	fhem ("setreading $SELF sum_cur $sum_cur");;;; \
	fhem ("setreading $SELF sum_safe $sum_safe");;;; \
	\
	### evaluate actual state\
    my $boiler_req = ($sum_req > $boilerActTreshold) ;;;; # is boiler heating needed?\
    my $valves_cur_opened =  ($sum_safe > $boilerActTreshold) ;;;;  # are valves CURRENTLY opened enough? sure???\
    #my $valves_cur_opened =  (($sum_safe > $boilerActTreshold) or ($sum_cur > $boilerActTreshold));;;;  # are valves CURRENTLY opened enough? sure???\
    \
    ### opentherm only: checkt whether OT bus is OK\
    my $boilerOTStatus = ReadingsVal($boilerDevice, $boilerOTStatusReadingName, "NA");;;;\
    if ( $boilerOTStatus ne "on") {\
        #  OT bus is shortened, boiler is turned on manually (old parallel thermostat is on?)\
    	Log 1, "$SELF: OT status $boilerOTStatus, BOILER IS MANUALLY ON?";;;;\
    } else {\
        Log 4, "$SELF: OT status $boilerOTStatus ok.";;;;\
    }\
    \
    ### update VALVES (if necessary)\
	if ($boiler_req or ($boilerOTStatus ne "on")) { # independent relay (boilerDevice) \
	#if ($boiler_req or $valves_cur_opened) {  # FHT relay (boiler listening to valves radio messages) \
		# ask for an update of valves actuations\
		for my $t (@T) {\
			#if ($t->{'req_val'} < $boilerActTreshold) {\
			   #my $corrected_req_val = ($t->{'req_val'} eq 0 ? 0 : $t->{'req_val'} + 10);;;;\
			   #my $corrected_req_val = $t->{'req_cal'} + 20;;;; # do not close valves\
               my $corrected_req_val = $t->{'req_cal'} + $t->{'shift'};;;; \
               $corrected_req_val = max (0, $corrected_req_val);;;;\
			   $corrected_req_val = min (100 ,$corrected_req_val);;;;\
			   if ($t->{'req_val'} > $corrected_req_val) { # safety first (pidActorErrorPos)\
			   		$corrected_req_val=$t->{'req_val'};;;; \
			   		};;;; \
			   if ($boilerOTStatus ne "on") { # opentherm only, OT bus is not OK, boiler forced manually on?\
			   		my $pidActorErrorPos = AttrVal($t->{'pid_dev'}, "pidActorErrorPos", 33);;;;\
					if ($corrected_req_val le $pidActorErrorPos) { \
					    # safety first, may be boiler is may be forced on thus open valves at least to error pos\
						Log 1, "$SELF: (VALVE $t->{'act_dev'}) OT bus status of is $boilerOTStatus, forcing pidActorErrorPos=$pidActorErrorPos";;;;\
						$corrected_req_val = $pidActorErrorPos;;;;\
						# TODO: Warn the user (BEEP)?\
						}\
					}			   		\
			   select(undef, undef, undef, 0.1);;;; # sleep in seconds\
			   fhem ("set $t->{'act_dev'} $setActCmd $corrected_req_val");;;;\
			   Log 1, "$SELF: (VALVE $t->{'act_dev'}) $t->{'req_name'}=$t->{'weight'}*$t->{'req_val'}, current=$t->{'weight'}*$t->{'cur_val'}, req=$t->{'req_val'}, cor_req=$corrected_req_val <set $t->{'act_dev'} $setActCmd $corrected_req_val>";;;;\
			#} else {\
			#   Log 1, "$SELF: (VALVE $t->{'act_dev'}) $t->{'req_name'}=$t->{'weight'}*$t->{'req_val'}, current=$t->{'weight'}*$t->{'cur_val'}, <set $t->{'act_dev'} $setActCmd 99>";;;;\
			#   fhem ("set $t->{'act_dev'} $setActCmd 99");;;;\
			#} ;;;;\
		}\
	 } else {\
		Log 1, "$SELF: (VALVES) IDLE, sum_req=$sum_req <= $boilerActTreshold=lim";;;;	 \
	    if (not($idleCmd eq "")) {\
	    	for my $t (@T) { fhem ("set $t->{'act_dev'} $idleCmd");;;; select(undef, undef, undef, 0.1);;;; } \
	    };;;;\
	 };;;;\
	\
	###  update opentherm BOILER\
	if ($boiler_req) {\
	    if( $valves_cur_opened) {\
			# turn boiler ON\
			my $sum_plus = 100;;;;\
			if ( ($equithermDevice ne "NA") and ($equithermReading ne "NA")) { # opentherm lite & equitherm\
				$sum_plus = ReadingsVal($equithermDevice, $equithermReading, $sum_req + 10);;;; \
			} else { # opentherm lite, no equitherm available\
				$sum_plus = $sum_req + 10;;;;\
			}\
            my $sum_constrained = ($sum_plus>100) ? 100 : $sum_plus;;;; # constrained_boiler_value \
			fhem "set $boilerDevice $boilerSetReading $sum_constrained";;;; # on\
			Log 1, "$SELF: $boilerDevice ON=$sum_constrained (req=$sum_req, cur=$sum_cur, safe=$sum_safe, lim=$boilerActTreshold)";;;;\
		}  else { \
			# turn boiler OFF, cannot heat when valves are not opened enough! \
			fhem "set $boilerDevice $boilerSetReading 0";;;; # off\
			Log 1, "$SELF: $boilerDevice OFF_HeatReq (req=$sum_req, cur=$sum_cur, safe=$sum_safe, lim=$boilerActTreshold)";;;;\
		}\
	} else {\
		# turn boiler OFF, heating not needed\
		fhem "set $boilerDevice $boilerSetReading 0";;;; # off\
		Log 1, "$SELF: $boilerDevice OFF_NoHeat (req=$sum_req, cur=$sum_cur, safe=$sum_safe, lim=$boilerActTreshold)";;;;\
	} ;;;;\
}
attr CENTRALA userattr actList boilerActTreshold boilerDevice boilerSetReadingName valveCurrentActReadingName valveSetActCmd valveIdleCmd EquithermDevice EquithermReadingName boilerOTStatusReadingName
attr CENTRALA EquithermDevice NOTIFY_EQUITHERM
attr CENTRALA EquithermReadingName t_w1_PID_M
attr CENTRALA actList modry_act,FHT_MODRY,PID_modry,1,100 obyvak_act,FHT_OBYVAK,PID_obyvak,2,100 zluty_act,FHT_ZLUTY,PID_zluty,0.7,100 koupelna_act,FHT_KOUPELNA,PID_koupelna,1,100
attr CENTRALA boilerActTreshold 20
attr CENTRALA boilerDevice MYSENSOR_KOTEL
attr CENTRALA boilerOTStatusReadingName status250
attr CENTRALA boilerSetReadingName percentage251
attr CENTRALA group centrala
attr CENTRALA room centrala
attr CENTRALA valveCurrentActReadingName pos_tx
attr CENTRALA valveIdleCmd fht_idle
attr CENTRALA valveSetActCmd fht_pos_percent
attr CENTRALA verbose 3


define FHT_HB ECMD serial /dev/ttyAMA0@57600
attr FHT_HB classdefs FHT_HB=/opt/fhem/FHT_HB.classdef
attr FHT_HB logTraffic 5
attr FHT_HB partial 5
attr FHT_HB requestSeparator �
attr FHT_HB room fht
attr FHT_HB split \n

define FHT_OBYVAK ECMDDevice FHT_HB 1
attr FHT_OBYVAK IODev FHT_HB
attr FHT_OBYVAK group fht
attr FHT_OBYVAK icon sani_heating
attr FHT_OBYVAK room Obývák,fht,centrala,domov
attr FHT_OBYVAK sortby 0
attr FHT_OBYVAK stateFormat pos_tx (centrala_act) % temp_DS18x20 °C
attr FHT_OBYVAK userReadings centrala_act {ReadingsVal("CENTRALA", "obyvak_act", "NA");;;;}
attr FHT_OBYVAK verbose 3

define FHT_MODRY ECMDDevice FHT_HB 2
attr FHT_MODRY IODev FHT_HB
attr FHT_MODRY group fht
attr FHT_MODRY icon sani_heating
attr FHT_MODRY room Ložnice,fht,centrala,domov
attr FHT_MODRY stateFormat pos_tx (centrala_act)  %, temperature °C
attr FHT_MODRY userReadings temperature {ReadingsVal("MYSENSOR_MODRY", "temperature3", "NA");;;;}, centrala_act {ReadingsVal("CENTRALA", "modry_act", "NA");;;;}

define FHT_ZLUTY ECMDDevice FHT_HB 3
attr FHT_ZLUTY IODev FHT_HB
attr FHT_ZLUTY group fht
attr FHT_ZLUTY icon sani_heating
attr FHT_ZLUTY room Dětský,fht,centrala,domov
attr FHT_ZLUTY stateFormat pos_tx (centrala_act) %, temperature °C
attr FHT_ZLUTY userReadings temperature {ReadingsVal("MYSENSOR_ZLUTY", "temperature", "NA");;;;},  centrala_act {ReadingsVal("CENTRALA", "zluty_act", "NA");;;;}

define FHT_KOUPELNA ECMDDevice FHT_HB 4
attr FHT_KOUPELNA IODev FHT_HB
attr FHT_KOUPELNA group fht
attr FHT_KOUPELNA icon sani_heating
attr FHT_KOUPELNA room Koupelna,fht,centrala,domov
attr FHT_KOUPELNA stateFormat pos_tx (centrala_act) %, temperature °C
attr FHT_KOUPELNA userReadings temperature {ReadingsVal("MYSENSOR_KOUPELNA", "temperature3", "NA");;;;},  centrala_act {ReadingsVal("CENTRALA", "koupelna_act", "NA");;;;}


define FHT_HB_LOG FileLog ./log/fht-%Y-%m.log FHT_HB:.*|FHT_KOUPELNA:.*|FHT_MODRY:.*|FHT_OBYVAK:.*|FHT_ZLUTY:.*
attr FHT_HB_LOG room fht

define SVG_FHT_HB_LOG_1 SVG FHT_HB_LOG:SVG_FHT_HB_LOG_1:CURRENT
attr SVG_FHT_HB_LOG_1 room Unsorted


#define RF24radioServer ECMD telnet localhost:9999
# define RF24radioServer ECMD serial /dev/ttyUSB0@57600
# attr RF24radioServer classdefs RF24radio=/opt/fhem/RF24radio.classdef
# attr RF24radioServer logTraffic 5
# attr RF24radioServer room centrala
# attr RF24radioServer verbose 3
# 
# 
# define RF24radioClientObyvak ECMDDevice RF24radio 3 1
# attr RF24radioClientObyvak IODev RF24radioServer
# attr RF24radioClientObyvak icon temp_temperature
# attr RF24radioClientObyvak room centrala,obyvak
# attr RF24radioClientObyvak verbose 3
# 
# define RF24radioClientLoznice ECMDDevice RF24radio 4 1
# attr RF24radioClientLoznice IODev RF24radioServer
# attr RF24radioClientLoznice fp_byt 50,250,0,
# attr RF24radioClientLoznice icon temp_temperature
# attr RF24radioClientLoznice room centrala,loznice
# attr RF24radioClientLoznice verbose 3
# 
# define RF24radioClient_1 ECMDDevice RF24radio 1 1
# attr RF24radioClient_1 IODev RF24radioServer
# attr RF24radioClient_1 icon temp_temperature
# attr RF24radioClient_1 room centrala,loznice


#define PID_obyvak PID20 FHT_OBYVAK:temp_DS18x20  FHT_OBYVAK:fht_pos_percent
define PID_obyvak PID20 FHT_OBYVAK:temp_DS18x20 CENTRALA:obyvak_act
attr PID_obyvak group pid
attr PID_obyvak icon temp_control
attr PID_obyvak pidActorErrorAction errorPos
attr PID_obyvak pidActorErrorPos 20
attr PID_obyvak pidActorTreshold 5
attr PID_obyvak pidDeltaTreshold 0.1
attr PID_obyvak pidFactor_I 0.05
attr PID_obyvak pidFactor_P 50
attr PID_obyvak room Obývák,centrala,daleko,domov,pid
attr PID_obyvak sortby 0
attr PID_obyvak stateFormat {sprintf("<font color=\"%s\"><small>%s %.0f %%, p<sub>P</sub>=%.0f p<sub>I</sub>=%.0f</small> t<sub>C</sub>=%s t<sub>D</sub>=%s</font>", \
(AttrVal($name, "disable", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "state", "unknown state"), \
ReadingsVal($name, "actuationCalc", -333e5),\
ReadingsVal($name, "p_p", -333e5),\
ReadingsVal($name, "p_i", -333e5),\
ReadingsVal($name, "measured", "N/A"), \
ReadingsVal($name, "desired", "N/A"))}
attr PID_obyvak userReadings pidFactor { my $pp = AttrVal("PID_obyvak", "pidFactor_P", "?");;;; my $pi = AttrVal("PID_obyvak", "pidFactor_I", "0.25");;;;  my $pd = AttrVal("PID_obyvak", "pidFactor_D", "0");;;; "$pp $pi $pd" }
attr PID_obyvak webCmd desired
attr PID_obyvak widgetOverride desired:10.0,13.0,15.0,16.0,16.5,17.0,17.5,18.0,18.5,19.0,19.5,20.0,20.5,21.0



#attr PID_obyvak userReadings pidFactor { my $pp = AttrVal("PID_obyvak", "pidFactor_P", "?");;;; my $pi = AttrVal("PID_obyvak", "pidFactor_I", "0.25");;;;  my $pd = AttrVal("PID_obyvak", "pidFactor_D", "0");;;; "P='$pp' I='$pi' D='$pd'" }


define PID_obyvak_LOG FileLog ./log/PID_obyvak-%Y-%m.log PID_obyvak:.*

define SVG_PID_obyvak_LOG_1 SVG PID_obyvak_LOG:SVG_PID_obyvak_LOG_1:CURRENT
attr SVG_PID_obyvak_LOG_1 room Obývák,pid

define SVG_PID_obyvak_LOG_2 SVG PID_obyvak_LOG:SVG_PID_obyvak_LOG_2:CURRENT
attr SVG_PID_obyvak_LOG_2 room Obývák,pid

define SVG_PID_obyvak_LOG_3 SVG PID_obyvak_LOG:SVG_PID_obyvak_LOG_3:CURRENT
attr SVG_PID_obyvak_LOG_3 room pid
#define rano at *06:00:00 set PID_obyvak desired 20
#define dopoledne at *07:00:00 set PID_obyvak desired 21.5
#define poledne at *12:30:00 set PID_obyvak desired 21
#define podvecer at *16:30:00 set PID_obyvak desired 22
#define noc at *23:30:00 set PID_obyvak desired 17


define PrgObyvak Heating_Control PID_obyvak en !$we|05:40|19.0 !$we|06:00|20 !$we|06:20|20.5 !$we|07:00|17 $we|07:00|20  16:00|20.0 19:00|18 21:00|17
attr PrgObyvak commandTemplate set $NAME desired $EVENT
attr PrgObyvak delayedExecutionCond {ReadingsVal("PRESENTHOME_DUMMY", "state", "home") ne "home"}
attr PrgObyvak disable 0
attr PrgObyvak group program
attr PrgObyvak icon time_calendar
attr PrgObyvak room Obývák,centrala,program
attr PrgObyvak sortby 0
attr PrgObyvak stateFormat {sprintf("<font color=\"%s\">%s (%s at %s)</font>", \
(ReadingsVal($name, "disabled", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "currValue", "?"),\
ReadingsVal($name, "nextValue", "?"),\
ReadingsVal($name, "nextUpdate", "?"))}

define PrgObyvakPrazdniny Heating_Control PID_obyvak en 00:30|16 07:00|20 16:00|20.5 19:00|18 21:00|17
attr PrgObyvakPrazdniny commandTemplate set $NAME desired $EVENT
attr PrgObyvakPrazdniny delayedExecutionCond {ReadingsVal("PRESENTHOME_DUMMY", "state", "home") ne "home"}
attr PrgObyvakPrazdniny disable 1
attr PrgObyvakPrazdniny group program
attr PrgObyvakPrazdniny icon time_calendar
attr PrgObyvakPrazdniny room Obývák,centrala
attr PrgObyvakPrazdniny stateFormat {sprintf("<font color=\"%s\">%s (%s at %s)</font>", \
(ReadingsVal($name, "disabled", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "currValue", "?"),\
ReadingsVal($name, "nextValue", "?"),\
ReadingsVal($name, "nextUpdate", "?"))}

define PrgZluty Heating_Control PID_zluty en $we|08:00|17 18:30|13
attr PrgZluty commandTemplate set $NAME desired $EVENT
attr PrgZluty delayedExecutionCond {ReadingsVal("PRESENTHOME_DUMMY", "state", "home") ne "home"}
attr PrgZluty disable 0
attr PrgZluty group program
attr PrgZluty icon time_calendar
attr PrgZluty room Dětský,centrala,program
attr PrgZluty stateFormat {sprintf("<font color=\"%s\">%s (%s at %s)</font>", \
(ReadingsVal($name, "disabled", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "currValue", "?"),\
ReadingsVal($name, "nextValue", "?"),\
ReadingsVal($name, "nextUpdate", "?"))}

define PrgKoupelna Heating_Control PID_koupelna en !$we|06:00|18 !$we|07:00|17 $we|08:00|18 16:00|19 20:00|17
attr PrgKoupelna commandTemplate set $NAME desired $EVENT
attr PrgKoupelna delayedExecutionCond {ReadingsVal("PRESENTHOME_DUMMY", "state", "home") ne "home"}
attr PrgKoupelna disable 0
attr PrgKoupelna group program
attr PrgKoupelna icon time_calendar
attr PrgKoupelna room Koupelna,centrala,program
attr PrgKoupelna stateFormat {sprintf("<font color=\"%s\">%s (%s at %s)</font>", \
(ReadingsVal($name, "disabled", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "currValue", "?"),\
ReadingsVal($name, "nextValue", "?"),\
ReadingsVal($name, "nextUpdate", "?"))}

define byt FLOORPLAN
attr byt CssFiles smallscreenstyle.css
attr byt fp_arrange 0
define d2 dummy
attr d2 eventMap /on-for-timer 10:go/
attr d2 fp_byt 360,326,1,,
attr d2 group lab
attr d2 room lab
attr d2 setList on off go offset:slider,-2,0.5,2,1
attr d2 useSetExtensions 1
attr d2 verbose 5
attr d2 webCmd offset:go

#define RPIUtils weblink htmlCode {ShowRpiValues()}

#define temps_LOG FileLog ./log/temps-%Y-%m.log FHT_OBYVAK:temp_DS18x20:.*|RF24radioClientLoznice:humidity:.*|RF24radioClientLoznice:temp:.*|RF24radioClientObyvak:temp:.*|RF24radioClient_1:temp:.*
#define SVG_temps_LOG_1 SVG temps_LOG:SVG_temps_LOG_1:CURRENT
#attr SVG_temps_LOG_1 fp_byt 250,100
#attr SVG_temps_LOG_1 room centrala,loznice,obyvak



#define OEPM_T1 HTTPMOD http://emoncms.org/input/post.json 60
#attr OEPM_T1 userattr disable set01Data set01Hint set01Name set01URL setHeader1 verbose
#attr OEPM_T1 disable 1
#attr OEPM_T1 set01Data 1
#attr OEPM_T1 set01Hint 6,10,20,30
#attr OEPM_T1 set01Name temp1
#attr OEPM_T1 set01URL http://emoncms.org/input/post.json?json={temp1:$val}&apikey=a8d488f87b024bdb7fe8399b9deb5cab
#attr OEPM_T1 setHeader1 Content-Type: application/json

#define Uploader_OEPM_loznice_hum notify RF24radioClientLoznice:humidity:.* "./upload_data_param 4 humidity $EVTPART1"
#define Uploader_OEPM_loznice_tmp notify RF24radioClientLoznice:temp:.* "./upload_data_param 4 temp $EVTPART1"


#define Uploader_OEPM_PID_obyvak_measured notify PID_obyvak:measured:.* "./upload_data_param 0 temp $EVTPART1"
#define Uploader_OEPM_PID_obyvak_desired notify PID_obyvak:desired:.* "./upload_data_param 0 desired_temp $EVTPART1"
#define Uploader_OEPM_PID_obyvak_actuation notify PID_obyvak:actuation:.* "./upload_data_param 0 actuation $EVTPART1"

# balkon
#define Uploader_OEPM_1_tmp notify MYSENSOR_BALKON:temperature:.* "./upload_data_param 1 temp $EVTPART1"
#define Uploader_OEPM_1_hum notify MYSENSOR_BALKON:humidity:.* "./upload_data_param 1 humidity $EVTPART1"
#define Uploader_OEPM_1_vcc notify MYSENSOR_BALKON:voltage:.* "./upload_data_param 1 voltage $EVTPART1"

# loznice
#define Uploader_OEPM_4_tmp notify MYSENSOR_MODRY:temperature:.* "./upload_data_param 4 temp $EVTPART1"
#define Uploader_OEPM_4_hum notify MYSENSOR_MODRY:humidity:.* "./upload_data_param 4 humidity $EVTPART1"
#define Uploader_OEPM_4_vcc notify MYSENSOR_MODRY:voltage:.* "./upload_data_param 4 voltage $EVTPART1"

define d2notify notify d2:.* set PID_obyvak desired $EVTPART0
attr d2notify verbose 5


#define myDummyServer ECMD telnet localhost:9999
#attr myDummyServer classdefs JSONdummy=/opt/fhem/JSONdummy.classdef
#attr myDummyServer logTraffic 5
#attr myDummyServer verbose 5

#define JSONdev ECMDDevice JSONdummy
#attr JSONdev IODev myDummyServer
#attr JSONdev verbose 5

# HB
#http://fhem.de/commandref.html#ECMDClassdef
#define myDummyServer ECMD telnet localhost:9999
#attr myDummyServer classdefs DummyServer=/opt/fhem/DummyServer.classdef
##define myDummyClient ECMDDevice DummyServer koko
#attr myDummyClient IODev myDummyServer

define MS_GW1 MYSENSORS localhost:5003
attr MS_GW1 autocreate 1
attr MS_GW1 devStateIcon connected:10px-kreis-gruen
attr MS_GW1 room mysensors
attr MS_GW1 stateFormat connection
attr MS_GW1 verbose 3

define MYSENSORS_LOG FileLog ./log/mysensors-%Y-%m.log MYSENSOR_.*:.*

define MYSENSORS_GW2_LOG FileLog ./log/mysensorsgw2-%Y-%m.log MYSENSOR_LOCAL:.*


define SVG_MYSENSORS_LOG_1 SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_1:CURRENT
attr SVG_MYSENSORS_LOG_1 fp_byt 127,175,0,,
attr SVG_MYSENSORS_LOG_1 room Dětský,Ložnice,Obývák,centrala,domov,teploty

# Ložnice, DHT22
define MYSENSOR_MODRY MYSENSORS_DEVICE 2
attr MYSENSOR_MODRY IODev MS_GW1
attr MYSENSOR_MODRY alias Modrý
attr MYSENSOR_MODRY group Teploměr
attr MYSENSOR_MODRY mapReading_humidity 2 humidity
attr MYSENSOR_MODRY mapReading_humidity2 2 humidity
attr MYSENSOR_MODRY mapReading_id1 1 id
attr MYSENSOR_MODRY mapReading_id3 3 id
attr MYSENSOR_MODRY mapReading_temperature 1 temperature
attr MYSENSOR_MODRY mapReading_temperature1 1 temperature
attr MYSENSOR_MODRY mapReading_temperature3 3 temperature
attr MYSENSOR_MODRY mapReading_value1 0 value1
attr MYSENSOR_MODRY mapReading_value11 1 value1
attr MYSENSOR_MODRY mapReading_value12 2 value1
attr MYSENSOR_MODRY mapReading_value2 0 value2
attr MYSENSOR_MODRY mapReading_value3 0 value3
attr MYSENSOR_MODRY mapReading_value4 0 value4
attr MYSENSOR_MODRY mapReading_value5 0 value5
attr MYSENSOR_MODRY mapReading_voltage 0 voltage
attr MYSENSOR_MODRY mode node
attr MYSENSOR_MODRY room centrala,Ložnice,mysensors,teploty,domov
attr MYSENSOR_MODRY setReading_value1 1
attr MYSENSOR_MODRY setReading_value11 1
attr MYSENSOR_MODRY setReading_value12 1
attr MYSENSOR_MODRY setReading_value2 1
attr MYSENSOR_MODRY setReading_value3 1
attr MYSENSOR_MODRY setReading_value4 1
attr MYSENSOR_MODRY setReading_value5 1
attr MYSENSOR_MODRY stateFormat temperature3 °C
attr MYSENSOR_MODRY version 1.5.1

# balkon, Dallas
define MYSENSOR_BALKON MYSENSORS_DEVICE 100
attr MYSENSOR_BALKON IODev MS_GW1
attr MYSENSOR_BALKON alias Balkon
attr MYSENSOR_BALKON fp_byt 10,846,1,,
attr MYSENSOR_BALKON group Teploměr
attr MYSENSOR_BALKON mapReading_humidity2 2 humidity
attr MYSENSOR_BALKON mapReading_id3 3 id
attr MYSENSOR_BALKON mapReading_temperature 3 temperature
attr MYSENSOR_BALKON mapReading_temperature1 1 temperature
attr MYSENSOR_BALKON mapReading_value1 0 value1
attr MYSENSOR_BALKON mapReading_value13 3 value1
attr MYSENSOR_BALKON mapReading_value2 0 value2
attr MYSENSOR_BALKON mapReading_value3 0 value3
attr MYSENSOR_BALKON mapReading_value4 0 value4
attr MYSENSOR_BALKON mapReading_value5 0 value5
attr MYSENSOR_BALKON mapReading_voltage 0 voltage
attr MYSENSOR_BALKON mode node
attr MYSENSOR_BALKON room Balkón,centrala,mysensors,teploty,domov
attr MYSENSOR_BALKON setReading_value1 1
attr MYSENSOR_BALKON setReading_value13 1
attr MYSENSOR_BALKON setReading_value2 1
attr MYSENSOR_BALKON setReading_value3 1
attr MYSENSOR_BALKON setReading_value4 1
attr MYSENSOR_BALKON setReading_value5 1
attr MYSENSOR_BALKON sortby -1
attr MYSENSOR_BALKON stateFormat temperature °C
attr MYSENSOR_BALKON version 1.5.4

# koupelna
define MYSENSOR_KOUPELNA MYSENSORS_DEVICE 103
attr MYSENSOR_KOUPELNA IODev MS_GW1
attr MYSENSOR_KOUPELNA alias Koupelna
attr MYSENSOR_KOUPELNA group Teploměr
attr MYSENSOR_KOUPELNA mapReading_id3 3 id
attr MYSENSOR_KOUPELNA mapReading_temperature3 3 temperature
attr MYSENSOR_KOUPELNA mapReading_value1 0 value1
attr MYSENSOR_KOUPELNA mapReading_value2 0 value2
attr MYSENSOR_KOUPELNA mapReading_value3 0 value3
attr MYSENSOR_KOUPELNA mapReading_value4 0 value4
attr MYSENSOR_KOUPELNA mapReading_value5 0 value5
attr MYSENSOR_KOUPELNA mapReading_voltage 0 voltage
attr MYSENSOR_KOUPELNA mode node
attr MYSENSOR_KOUPELNA room Koupelna,centrala,mysensors,teploty,domov
attr MYSENSOR_KOUPELNA setReading_value1 1
attr MYSENSOR_KOUPELNA setReading_value2 1
attr MYSENSOR_KOUPELNA setReading_value3 1
attr MYSENSOR_KOUPELNA setReading_value4 1
attr MYSENSOR_KOUPELNA setReading_value5 1
attr MYSENSOR_KOUPELNA stateFormat temperature3 °C
attr MYSENSOR_KOUPELNA version 1.5.4

# žlutý
define MYSENSOR_ZLUTY MYSENSORS_DEVICE 104
attr MYSENSOR_ZLUTY IODev MS_GW1
attr MYSENSOR_ZLUTY alias Žlutý
attr MYSENSOR_ZLUTY group Teploměr
attr MYSENSOR_ZLUTY mapReading_id3 3 id
attr MYSENSOR_ZLUTY mapReading_temperature 3 temperature
attr MYSENSOR_ZLUTY mapReading_value1 0 value1
attr MYSENSOR_ZLUTY mapReading_value2 0 value2
attr MYSENSOR_ZLUTY mapReading_value3 0 value3
attr MYSENSOR_ZLUTY mapReading_value4 0 value4
attr MYSENSOR_ZLUTY mapReading_value5 0 value5
attr MYSENSOR_ZLUTY mapReading_voltage 0 voltage
attr MYSENSOR_ZLUTY mode node
attr MYSENSOR_ZLUTY room Dětský,centrala,domov,lab,mysensors,teploty
attr MYSENSOR_ZLUTY setReading_value1 1
attr MYSENSOR_ZLUTY setReading_value2 1
attr MYSENSOR_ZLUTY setReading_value3 1
attr MYSENSOR_ZLUTY setReading_value4 1
attr MYSENSOR_ZLUTY setReading_value5 1
attr MYSENSOR_ZLUTY stateFormat temperature °C
attr MYSENSOR_ZLUTY version 1.5.4


define MYSENSOR_TEST MYSENSORS_DEVICE 102
attr MYSENSOR_TEST IODev MS_GW1
attr MYSENSOR_TEST group Teploměr
attr MYSENSOR_TEST mapReading_humidity2 2 humidity
attr MYSENSOR_TEST mapReading_id1 1 id
attr MYSENSOR_TEST mapReading_id3 3 id
attr MYSENSOR_TEST mapReading_temperature1 1 temperature
attr MYSENSOR_TEST mapReading_temperature3 3 temperature
attr MYSENSOR_TEST mapReading_value1 0 value1
attr MYSENSOR_TEST mapReading_value11 1 value1
attr MYSENSOR_TEST mapReading_value12 2 value1
attr MYSENSOR_TEST mapReading_value13 3 value1
attr MYSENSOR_TEST mapReading_value2 0 value2
attr MYSENSOR_TEST mapReading_value3 0 value3
attr MYSENSOR_TEST mapReading_value4 0 value4
attr MYSENSOR_TEST mapReading_value5 0 value5
attr MYSENSOR_TEST mode repeater
attr MYSENSOR_TEST room centrala,domov,mysensors,teploty
attr MYSENSOR_TEST setReading_value11 1
attr MYSENSOR_TEST setReading_value12 1
attr MYSENSOR_TEST setReading_value13 1
attr MYSENSOR_TEST stateFormat temperature3 °C
attr MYSENSOR_TEST version 1.5.1


define PID_modry PID20 MYSENSOR_MODRY:temperature3 CENTRALA:modry_act
attr PID_modry devStateIcon disabled:temp_frost
attr PID_modry disable 0
attr PID_modry fp_byt 45,433,5,desired,
attr PID_modry group pid
attr PID_modry icon temp_control
attr PID_modry pidActorErrorAction errorPos
attr PID_modry pidActorErrorPos 30
attr PID_modry pidActorTreshold 5
attr PID_modry pidDeltaTreshold 0.1
attr PID_modry pidFactor_I 0.5
attr PID_modry pidFactor_P 50
attr PID_modry room Ložnice,daleko,centrala,lab,pid,domov
attr PID_modry stateFormat {sprintf("<font color=\"%s\"><small>%s %.0f %%, p<sub>P</sub>=%.0f p<sub>I</sub>=%.0f</small> t<sub>C</sub>=%s t<sub>D</sub>=%s</font>", \
(AttrVal($name, "disable", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "state", "unknown state"), \
ReadingsVal($name, "actuationCalc", -333e5),\
ReadingsVal($name, "p_p", -333e5),\
ReadingsVal($name, "p_i", -333e5),\
ReadingsVal($name, "measured", "N/A"), \
ReadingsVal($name, "desired", "N/A"))}
attr PID_modry userReadings pidFactor { my $pp = AttrVal("PID_modry", "pidFactor_P", "?");;;; my $pi = AttrVal("PID_modry", "pidFactor_I", "0.25");;;;  my $pd = AttrVal("PID_modry", "pidFactor_D", "0");;;; "$pp $pi $pd" }
attr PID_modry webCmd desired
attr PID_modry widgetOverride desired:10.0,13.0,15.0,15.5,16.0,16.5,17.0,17.5,18.0,18.5,19.0,19.5,20.0,20.5,21.0

define PID_modry_LOG FileLog ./log/PID_modry-%Y-%m.log PID_modry:.*

define KOTEL_LOG FileLog ./log/KOTEL-%Y-%m.log CENTRALA:.*|CENTRALA:.*|KOTEL:.*
define SVG_KOTEL_LOG_1 SVG KOTEL_LOG:SVG_KOTEL_LOG_1:CURRENT
attr SVG_KOTEL_LOG_1 room centrala




define PID_zluty PID20 MYSENSOR_ZLUTY:temperature CENTRALA:zluty_act
attr PID_zluty fp_byt 45,603,5,desired,
attr PID_zluty group pid
attr PID_zluty icon temp_control
attr PID_zluty pidActorErrorAction errorPos
attr PID_zluty pidActorErrorPos 30
attr PID_zluty pidActorTreshold 5
attr PID_zluty pidDeltaTreshold 0.1
attr PID_zluty pidFactor_I 0.2
attr PID_zluty pidFactor_P 50
attr PID_zluty room Dětský,daleko,centrala,pid,domov
attr PID_zluty stateFormat {sprintf("<font color=\"%s\"><small>%s %.0f %%, p<sub>P</sub>=%.0f p<sub>I</sub>=%.0f</small> t<sub>C</sub>=%s t<sub>D</sub>=%s</font>", \
(AttrVal($name, "disable", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "state", "unknown state"), \
ReadingsVal($name, "actuationCalc", -333e5),\
ReadingsVal($name, "p_p", -333e5),\
ReadingsVal($name, "p_i", -333e5),\
ReadingsVal($name, "measured", "N/A"), \
ReadingsVal($name, "desired", "N/A"))}
attr PID_zluty userReadings pidFactor { my $pp = AttrVal("PID_zluty", "pidFactor_P", "?");;;; my $pi = AttrVal("PID_zluty", "pidFactor_I", "0.25");;;;  my $pd = AttrVal("PID_zluty", "pidFactor_D", "0");;;; "$pp $pi $pd" }
attr PID_zluty webCmd desired
attr PID_zluty widgetOverride desired:10.0,13.0,15.0,16.0,16.5,17.0,17.5,18.0,18.5,19.0,19.5,20.0,20.5,21.0

define PID_zluty_LOG FileLog ./log/PID_zluty-%Y-%m.log PID_zluty:.*


define PID_koupelna PID20 MYSENSOR_KOUPELNA:temperature3 CENTRALA:koupelna_act
attr PID_koupelna fp_byt 45,603,5,desired,
attr PID_koupelna group pid
attr PID_koupelna icon temp_control
attr PID_koupelna pidActorErrorAction errorPos
attr PID_koupelna pidActorErrorPos 15
attr PID_koupelna pidActorTreshold 5
attr PID_koupelna pidDeltaTreshold 0.1
attr PID_koupelna pidFactor_I 0.02
attr PID_koupelna pidFactor_P 75
attr PID_koupelna room Koupelna,daleko,centrala,pid,domov
attr PID_koupelna stateFormat {sprintf("<font color=\"%s\"><small>%s %.0f %%, p<sub>P</sub>=%.0f p<sub>I</sub>=%.0f</small> t<sub>C</sub>=%s t<sub>D</sub>=%s</font>", \
(AttrVal($name, "disable", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "state", "unknown state"), \
ReadingsVal($name, "actuationCalc", -333e5),\
ReadingsVal($name, "p_p", -333e5),\
ReadingsVal($name, "p_i", -333e5),\
ReadingsVal($name, "measured", "N/A"), \
ReadingsVal($name, "desired", "N/A"))}
attr PID_koupelna userReadings pidFactor { my $pp = AttrVal("PID_koupelna", "pidFactor_P", "?");;;; my $pi = AttrVal("PID_koupelna", "pidFactor_I", "0.25");;;;  my $pd = AttrVal("PID_koupelna", "pidFactor_D", "0");;;; "$pp $pi $pd" }
attr PID_koupelna webCmd desired
attr PID_koupelna widgetOverride desired:10.0,15.0,16.0,16.5,17.0,17.5,18.0,18.5,19.0,19.5,20.0,20.5,21.0

define PID_koupelna_LOG FileLog ./log/PID_koupelna-%Y-%m.log PID_koupelna:.*


define SVG_KOTEL_LOG_2 SVG KOTEL_LOG:SVG_KOTEL_LOG_2:CURRENT
attr SVG_KOTEL_LOG_2 room centrala

define reset_PID at *00:00 setreading PID_modry p_i 0;; setreading PID_obyvak p_i 0;; setreading PID_zluty p_i 0;; setreading PID_koupelna p_i 0;;
attr reset_PID room pid

define DUMMY_POKUS1 dummy
attr DUMMY_POKUS1 fp_byt 360,239,1,,
attr DUMMY_POKUS1 group lab
attr DUMMY_POKUS1 readingList a b c d e f g h i j k l
attr DUMMY_POKUS1 room lab
attr DUMMY_POKUS1 setList a:doma,venku b c d e f g h i j k l
attr DUMMY_POKUS1 widgetOverride b:uzsuToggle,doma,venku c:time d:knob,min:1,max:24 e:uzsuTimerEntry f:uzsu,uzsuTimerEntry g:uzsu,uzsuDropDown,18,18.5,19,19.5,20,20.5,21 h:uzsu i:uzsu,knob,min:18,max:24,step:0.5,linecap:round,fgColor:red
define CENTRALA_AT at +*00:01:00  trigger CENTRALA
attr CENTRALA_AT group centrala
attr CENTRALA_AT room Unsorted
define DUMMY_ONOFF dummy
attr DUMMY_ONOFF devStateIcon on::off off::go
attr DUMMY_ONOFF eventMap /on-for-timer 2:go/
attr DUMMY_ONOFF fp_byt 360,412,1,,
attr DUMMY_ONOFF group lab,
attr DUMMY_ONOFF room lab
attr DUMMY_ONOFF setList on off go
attr DUMMY_ONOFF useSetExtensions 1
attr DUMMY_ONOFF verbose 5
define anyViews Dashboard
attr anyViews userattr dashboard_tab2backgroundimage dashboard_tab2colcount dashboard_tab2devices dashboard_tab2groups dashboard_tab2icon dashboard_tab2name dashboard_tab2rowcentercolwidth dashboard_tab2sorting dashboard_tab3backgroundimage dashboard_tab3colcount dashboard_tab3devices dashboard_tab3groups dashboard_tab3icon dashboard_tab3name dashboard_tab3rowcentercolwidth dashboard_tab3sorting
attr anyViews dashboard_activetab 1
attr anyViews dashboard_flexible 20
attr anyViews dashboard_row center
attr anyViews dashboard_tab1devices SVG_MYSENSORS_LOG_1,SVG_KOTEL_LOG_2
attr anyViews dashboard_tab1groups Teploměr,fht,pid, program,stav
attr anyViews dashboard_tab1name Doma
attr anyViews dashboard_tab1sorting t0c0,Teploměr,true,120,247,820,240:t0c0,fht,true,320,212,0,0:t0c0,pid,true,460,325,320,0:t0c0,SVG_MYSENSORS_LOG_1,true,760,195,0,200:t0c0,SVG_KOTEL_LOG_2,true,760,205,0,360:t0c0,program,true,360,237,780,0:
attr anyViews dashboard_tab2groups lab
attr anyViews dashboard_tab2name Lab
attr anyViews dashboard_tab2sorting t1c0,lab,true,400,0,0,0:t1c0,RESIDENTS,true,246,49,400,0:
define TMP_OBYVAK cloneDummy FHT_OBYVAK
attr TMP_OBYVAK alias Obývák
attr TMP_OBYVAK group Teploměr
attr TMP_OBYVAK room centrala,teploty,domov
attr TMP_OBYVAK sortby 0
attr TMP_OBYVAK stateFormat temp_DS18x20 °C

define PrgModry Heating_Control PID_modry en !$we|06:00|16.5 !$we|06:30|13 $we|10:00|13 19:00|16
attr PrgModry commandTemplate set $NAME desired $EVENT
attr PrgModry delayedExecutionCond {ReadingsVal("PRESENTHOME_DUMMY", "state", "home") ne "home"}
attr PrgModry disable 0
attr PrgModry fp_byt 86,404,0,desired
attr PrgModry group program
attr PrgModry icon time_calendar
attr PrgModry room Ložnice,centrala,lab,program
attr PrgModry stateFormat {sprintf("<font color=\"%s\">%s (%s at %s)</font>", \
(ReadingsVal($name, "disabled", "0") eq "0") ?  "green" : "blue",\
ReadingsVal($name, "currValue", "?"),\
ReadingsVal($name, "nextValue", "?"),\
ReadingsVal($name, "nextUpdate", "?"))}
# {set $NAME modry_tmp_rq $EVENT }

define SVG_MYSENSORS_LOG_2 SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_2:CURRENT
attr SVG_MYSENSORS_LOG_2 room Balkón,centrala,mysensors,teploty

define SVG_MYSENSORS_LOG_KOUPELNA SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_KOUPELNA:CURRENT
attr SVG_MYSENSORS_LOG_KOUPELNA room Koupelna,mysensors,teploty


define BACK_TO_PRG_NOTIFY notify BACK_TO_PRG_NOTIFY:.*|PRESENTHOME_DUMMY:.*|BACK_TO_PRG_TIMER_DUMMY:.* {\
        Log 1, "$SELF: $NAME  $EVENT";;;;\
\
	my $room_list 		  = AttrVal($SELF, "roomList", "");;;; \
\
	my @rooms = split(' ', $room_list);;;; # space separated\
\
	for my $r (@rooms) {\
		my @s =  split(',', $r);;;; # comma separated\
		my $pid = $s[0];;;;\
		my $home_prg = $s[1];;;;\
		my $away_temp = $s[2];;;;\
			\
        #Log 1, "$SELF: '$NAME',  '$EVENT', room pid=$pid, home_prg=$home_prg, away_temp=$away_temp";;;;\
        #Log 1, ReadingsVal($home_prg, "disabled", "0");;;;	           	\
\
        if (ReadingsVal($home_prg, "disabled", "0") eq 1) {\
        	# room program is disabled, do not change anything\
        	Log 5, "$SELF: '$NAME',  '$EVENT', program DISABLED, room pid=$pid, home_prg=$home_prg, away_temp=$away_temp";;;;	           	\
        	\
        } else {\
	        Log 5, "$SELF: '$NAME',  '$EVENT', switching room pid=$pid, home_prg=$home_prg, away_temp=$away_temp";;;;	   \
			if (($EVENT eq "away") or  ($EVENT eq "away2home")) {\
				# fhem("set $home_prg disable");;;;\
				fhem("set $pid desired ". sprintf("%.1f",$away_temp));;;;\
			} elsif ($EVENT eq "home") {\
				my $currentPrgValue = ReadingsVal($home_prg, "currValue", $away_temp);;;;\
				fhem("set $pid desired ". sprintf("%.1f",$currentPrgValue));;;;\
				# fhem("set $home_prg enable");;;;\
			} elsif ($EVTPART0 eq "next_time") { \
				my $timer = $NAME."_AT";;;;\
				#fhem("set $timer modifyTimeSpec $EVTPART1");;;;\
				my @evt = split(' ', $EVENT);;;;\
				fhem("define $timer at $evt[1] set PRESENTHOME_DUMMY home");;;;\
				fhem("set PRESENTHOME_DUMMY away2home");;;;\
\
			} else {\
			   Log 0, "$SELF: Unknown event '$NAME', '$EVENT'";;;;\
			   Log 0, "$EVTPART0";;;;\
			}\
		}\
	}\
	\
	# disable boosters\
	if ($EVENT eq "away") {\
	  fhem("set SWITCH_BOOSTER_.* off");;;;\
	}\
}
attr BACK_TO_PRG_NOTIFY userattr roomList
attr BACK_TO_PRG_NOTIFY room lab
attr BACK_TO_PRG_NOTIFY roomList PID_modry,PrgModry,13 PID_zluty,PrgZluty,13 PID_obyvak,PrgObyvak,17 PID_koupelna,PrgKoupelna,17
attr BACK_TO_PRG_NOTIFY verbose 3

define PRESENTHOME_DUMMY dummy
attr PRESENTHOME_DUMMY alias Jsme doma?
attr PRESENTHOME_DUMMY devStateIcon home:status_available.svg@red:away away:status_away_1.svg@blue:home away2home:status_away_2@pink:home
attr PRESENTHOME_DUMMY group stav domu
attr PRESENTHOME_DUMMY icon control_building_empty
attr PRESENTHOME_DUMMY room Miki,daleko,centrala,domov
attr PRESENTHOME_DUMMY setList state:home,away,away2home

define BACK_TO_PRG_TIMER_DUMMY dummy
attr BACK_TO_PRG_TIMER_DUMMY group lab
attr BACK_TO_PRG_TIMER_DUMMY room lab
attr BACK_TO_PRG_TIMER_DUMMY setList next_time:time
attr BACK_TO_PRG_TIMER_DUMMY verbose 3


define MYSENSOR_KOTEL MYSENSORS_DEVICE 1
attr MYSENSOR_KOTEL IODev MS_GW1
attr MYSENSOR_KOTEL group centrala
attr MYSENSOR_KOTEL icon sani_boiler_temp
attr MYSENSOR_KOTEL mapReading_armed1 1 armed
attr MYSENSOR_KOTEL mapReading_id3 3 id
attr MYSENSOR_KOTEL mapReading_id4 4 id
attr MYSENSOR_KOTEL mapReading_id5 5 id
attr MYSENSOR_KOTEL mapReading_percentage251 251 percentage
attr MYSENSOR_KOTEL mapReading_percentage252 252 percentage
attr MYSENSOR_KOTEL mapReading_power251 251 power
attr MYSENSOR_KOTEL mapReading_status250 250 status
attr MYSENSOR_KOTEL mapReading_status251 251 status
attr MYSENSOR_KOTEL mapReading_temperature3 3 temperature
attr MYSENSOR_KOTEL mapReading_temperature4 4 temperature
attr MYSENSOR_KOTEL mapReading_temperature5 5 temperature
attr MYSENSOR_KOTEL mapReading_tripped1 1 tripped
attr MYSENSOR_KOTEL mapReading_value1253 253 value1
attr MYSENSOR_KOTEL mapReading_value13 3 value1
attr MYSENSOR_KOTEL mapReading_value14 4 value1
attr MYSENSOR_KOTEL mapReading_value15 5 value1
attr MYSENSOR_KOTEL mapReading_value2253 253 value2
attr MYSENSOR_KOTEL mapReading_value3253 253 value3
attr MYSENSOR_KOTEL mapReading_value4253 253 value4
attr MYSENSOR_KOTEL mapReading_value5253 253 value5
attr MYSENSOR_KOTEL mode repeater
attr MYSENSOR_KOTEL room daleko,centrala,domov
attr MYSENSOR_KOTEL setReading_percentage251 slider,0,1,100
attr MYSENSOR_KOTEL setReading_power251 1
attr MYSENSOR_KOTEL setReading_status251 off,on
attr MYSENSOR_KOTEL setReading_value1253 textField
attr MYSENSOR_KOTEL setReading_value2253 1
attr MYSENSOR_KOTEL setReading_value3253 1
attr MYSENSOR_KOTEL setReading_value4253 1
attr MYSENSOR_KOTEL setReading_value5253 1
attr MYSENSOR_KOTEL stateFormat percentage251 (percentage252) % value1253 [status250]
attr MYSENSOR_KOTEL version 1.5.4
# temperatures
# boiler pwm SET
#attr MYSENSOR_KOTEL mapReading_power251 251 power
#attr MYSENSOR_KOTEL mapReading_status251 251 status
#attr MYSENSOR_KOTEL setReading_status251 off,on
# boiler pwm ACK
#attr MYSENSOR_KOTEL setReading_percentage252 slider,0,1,100
#attr MYSENSOR_KOTEL mapReading_power252 252 power
#attr MYSENSOR_KOTEL mapReading_status252 252 status
#attr MYSENSOR_KOTEL setReading_status252 off,on
# opentherm lite boiler status
# general text messages



define temps readingsGroup .*:temp.*
attr temps room lab
define MYSENSOR_KOTEL_HISTORY readingsHistory MYSENSOR_KOTEL:.*
attr MYSENSOR_KOTEL_HISTORY room lab

define actuations_CENTRALA readingsGroup CENTRALA:.*act CENTRALA:sum.*
attr actuations_CENTRALA room centrala
attr actuations_CENTRALA sortDevices 1

define actuations_FHT readingsGroup FHT_.*:pos.* FHT_.*:centrala.*
attr actuations_FHT room centrala
attr actuations_FHT sortDevices 1

define SWITCH_BOOSTER_OBYVAK dummy
attr SWITCH_BOOSTER_OBYVAK userattr p_pidControlDevice p_boostDelta
attr SWITCH_BOOSTER_OBYVAK alias Přihřej obývák
attr SWITCH_BOOSTER_OBYVAK devStateIcon off:sani_heating_automatic@green:go on:sani_heating_level_100@red:off
attr SWITCH_BOOSTER_OBYVAK eventMap /on-for-timer 1800:go/on-for-timer 10:test/
attr SWITCH_BOOSTER_OBYVAK group stav místnosti
attr SWITCH_BOOSTER_OBYVAK icon temp_control
attr SWITCH_BOOSTER_OBYVAK p_boostDelta 0.5
attr SWITCH_BOOSTER_OBYVAK p_pidControlDevice PID_obyvak
attr SWITCH_BOOSTER_OBYVAK room Miki,Obývák,centrala,domov
attr SWITCH_BOOSTER_OBYVAK setList on off go test
attr SWITCH_BOOSTER_OBYVAK sortby 0
attr SWITCH_BOOSTER_OBYVAK useSetExtensions 1
attr SWITCH_BOOSTER_OBYVAK verbose 0
attr SWITCH_BOOSTER_OBYVAK webCmd off:on:test:go

define SWITCH_BOOSTER_ZLUTY dummy
attr SWITCH_BOOSTER_ZLUTY userattr p_pidControlDevice p_boostDelta
attr SWITCH_BOOSTER_ZLUTY alias Přihřej žlutý
attr SWITCH_BOOSTER_ZLUTY devStateIcon off:sani_heating_automatic@green:go on:sani_heating_level_100@red:off
attr SWITCH_BOOSTER_ZLUTY eventMap /on-for-timer 1800:go/on-for-timer 10:test/
attr SWITCH_BOOSTER_ZLUTY group stav místnosti
attr SWITCH_BOOSTER_ZLUTY icon temp_control
attr SWITCH_BOOSTER_ZLUTY p_boostDelta 1
attr SWITCH_BOOSTER_ZLUTY p_pidControlDevice PID_zluty
attr SWITCH_BOOSTER_ZLUTY room Miki,centrala,Dětský,domov
attr SWITCH_BOOSTER_ZLUTY setList on off go test
attr SWITCH_BOOSTER_ZLUTY useSetExtensions 1
attr SWITCH_BOOSTER_ZLUTY verbose 0
attr SWITCH_BOOSTER_ZLUTY webCmd off:on:test:go

define SWITCH_BOOSTER_MODRY dummy
attr SWITCH_BOOSTER_MODRY userattr p_pidControlDevice p_boostDelta
attr SWITCH_BOOSTER_MODRY alias Přihřej modrý
attr SWITCH_BOOSTER_MODRY devStateIcon off:sani_heating_automatic@green:go on:sani_heating_level_100@red:off
attr SWITCH_BOOSTER_MODRY eventMap /on-for-timer 1800:go/on-for-timer 10:test/
attr SWITCH_BOOSTER_MODRY group stav místnosti
attr SWITCH_BOOSTER_MODRY icon temp_control
attr SWITCH_BOOSTER_MODRY p_boostDelta 2
attr SWITCH_BOOSTER_MODRY p_pidControlDevice PID_modry
attr SWITCH_BOOSTER_MODRY room Miki,centrala,Ložnice,domov
attr SWITCH_BOOSTER_MODRY setList on off go test
attr SWITCH_BOOSTER_MODRY useSetExtensions 1
attr SWITCH_BOOSTER_MODRY verbose 0
attr SWITCH_BOOSTER_MODRY webCmd off:on:test:go

define SWITCH_BOOSTER_KOUPELNA dummy
attr SWITCH_BOOSTER_KOUPELNA userattr p_pidControlDevice p_boostDelta
attr SWITCH_BOOSTER_KOUPELNA alias Přihřej koupelnu
attr SWITCH_BOOSTER_KOUPELNA devStateIcon off:sani_heating_automatic@green:go on:sani_heating_level_100@red:off
attr SWITCH_BOOSTER_KOUPELNA eventMap /on-for-timer 1800:go/on-for-timer 10:test/
attr SWITCH_BOOSTER_KOUPELNA group stav místnosti
attr SWITCH_BOOSTER_KOUPELNA icon temp_control
attr SWITCH_BOOSTER_KOUPELNA p_boostDelta 2
attr SWITCH_BOOSTER_KOUPELNA p_pidControlDevice PID_koupelna
attr SWITCH_BOOSTER_KOUPELNA room Miki,centrala,Koupelna,domov
attr SWITCH_BOOSTER_KOUPELNA setList on off go test
attr SWITCH_BOOSTER_KOUPELNA useSetExtensions 1
attr SWITCH_BOOSTER_KOUPELNA verbose 0
attr SWITCH_BOOSTER_KOUPELNA webCmd off:on:test:go


define rolltest dummy
attr rolltest devStateIcon off:sani_heating_automatic on:sani_heating_level_100
attr rolltest eventMap /on-for-timer 3:long/on-for-timer 1:short/
attr rolltest room lab
attr rolltest setList on off
attr rolltest useSetExtensions 1
attr rolltest webCmd off:short:long

define NOTIFY_BOOSTER notify SWITCH_BOOSTER_.*:.* {\
  Log 3, "$SELF: '$NAME', '$EVENT'";;;;\
  my $e = $EVTPART0;;;;\
\
  my $pidDev = AttrVal($NAME, "p_pidControlDevice", "N/A");;;;\
  my $boostDelta = AttrVal($NAME, "p_boostDelta", "N/A");;;;\
\
  my $desiredPIDTemp   = ReadingsVal($pidDev, "desired", "N/A");;;; \
\
  my $savedDesiredTemp = ReadingsVal($NAME, "savedDesiredTemp", "N/A");;;;\
  my $savedBoostedTemp = ReadingsVal($NAME, "savedBoostedTemp", "N/A");;;;\
  \
  if ($e eq "on") {\
    if (not($savedDesiredTemp eq "N/A")) {\
      Log 0, "$SELF: $pidDev desired already boosted to $desiredPIDTemp";;;;\
      $desiredPIDTemp;;;;\
    } else {\
      Log 2, "$SELF: Storing $pidDev desired $desiredPIDTemp";;;;\
      fhem ("setreading $NAME savedDesiredTemp $desiredPIDTemp");;;;\
      # Boost PID desired\
      my $newTemp = sprintf("%.1f",$desiredPIDTemp + $boostDelta);;;;\
      Log 2, "$SELF: Boosting $pidDev to $newTemp";;;;\
      fhem ("setreading $NAME savedBoostedTemp $newTemp");;;;\
      fhem ("set $pidDev desired $newTemp");;;;\
      $newTemp;;;;\
    }\
  } elsif ($e eq "off"){\
    if ($desiredPIDTemp eq $savedBoostedTemp) {\
       Log 2, "$SELF: Restoring $pidDev desired to $savedDesiredTemp";;;;\
       fhem ("set $pidDev desired $savedDesiredTemp");;;;\
    } else {\
       Log 2, "$SELF: Cannot restore $pidDev desired, it was changed. $desiredPIDTemp<>$savedBoostedTemp";;;;\
    }\
    fhem("deletereading $NAME savedDesiredTemp");;;;\
    fhem("deletereading $NAME savedBoostedTemp");;;;\
    \
\
  } else {\
    Log 0, "$SELF: Unknown event '$NAME', '$EVENT'";;;;\
  } \
}\

attr NOTIFY_BOOSTER room lab
attr NOTIFY_BOOSTER verbose 3
define SWITCHES_HISTORY readingsHistory PRESENTHOME_DUMMY SWITCH_BOOSTER_.*
attr SWITCHES_HISTORY group z historie stavů
attr SWITCHES_HISTORY room centrala,lab
attr SWITCHES_HISTORY rows 15
attr SWITCHES_HISTORY timestampFormat %a %d, %H:%M

define dashMirka Dashboard
attr dashMirka userattr dashboard_tab2backgroundimage dashboard_tab2colcount dashboard_tab2devices dashboard_tab2groups dashboard_tab2icon dashboard_tab2name dashboard_tab2rowcentercolwidth dashboard_tab2sorting dashboard_tab3backgroundimage dashboard_tab3colcount dashboard_tab3devices dashboard_tab3groups dashboard_tab3icon dashboard_tab3name dashboard_tab3rowcentercolwidth dashboard_tab3sorting
attr dashMirka dashboard_customcss svg { height:36px;; width:36px;; vertical-align:middle;; padding:2px} .dashboard_tabcontent { font-size:20px }
attr dashMirka dashboard_showfullsize 1
attr dashMirka dashboard_tab1colcount 1
attr dashMirka dashboard_tab1devices MYSENSOR_BALKON
attr dashMirka dashboard_tab1groups stav domu, stav místnosti
attr dashMirka dashboard_tab1name Stav
attr dashMirka dashboard_tab2devices SVG_MYSENSORS_LOG_1,  SVG_MYSENSORS_LOG_2
attr dashMirka dashboard_tab2groups Teploměr
attr dashMirka dashboard_tab2name Teploty

define SVG_MYSENSORS_LOG_3 SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_3:CURRENT
attr SVG_MYSENSORS_LOG_3 room mysensors

define SVG_FHT_HB_LOG_2 SVG FHT_HB_LOG:SVG_FHT_HB_LOG_2:CURRENT
attr SVG_FHT_HB_LOG_2 room fht
attr SVG_FHT_HB_LOG_2 sortby 1


define HISTORY_PRESENTHOME readingsHistory PRESENTHOME_DUMMY
attr HISTORY_PRESENTHOME group z historie stavů
attr HISTORY_PRESENTHOME room centrala,program
attr HISTORY_PRESENTHOME timestampFormat %a %d, %H:%M
define HISTORY_FHT readingsHistory FHT_OBYVAK:err_freezing,err_panic
attr HISTORY_FHT room fht
attr HISTORY_FHT rows 50
attr HISTORY_FHT sortby 100
attr HISTORY_FHT timestampFormat %a %d. %m., %H:%M
define MS_GW2 MYSENSORS 192.168.11.144:5003
attr MS_GW2 room mysensors
attr MS_GW2 stateFormat connection
define MYSENSOR_LOCAL MYSENSORS_DEVICE 0
attr MYSENSOR_LOCAL IODev MS_GW2
attr MYSENSOR_LOCAL group Teploměr
attr MYSENSOR_LOCAL mapReading_humidity 2 humidity
attr MYSENSOR_LOCAL mapReading_temperature 1 temperature
attr MYSENSOR_LOCAL mapReading_value1 3 value1
attr MYSENSOR_LOCAL mode node
attr MYSENSOR_LOCAL room centrala,lab,mysensors,teploty
attr MYSENSOR_LOCAL setReading_value1 textField
attr MYSENSOR_LOCAL stateFormat temperature °C, humidity %
attr MYSENSOR_LOCAL version 2.1.1
define SVG_MYSENSORS_LOG_GW2LOCAL SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_GW2LOCAL:CURRENT
attr SVG_MYSENSORS_LOG_GW2LOCAL room mysensors,teploty
define PJSIP ECMD telnet localhost:9999
attr PJSIP classdefs PJSIPclass=/opt/fhem/PJSIP.classdef
attr PJSIP logTraffic 5
attr PJSIP requestSeparator �
attr PJSIP room sip
attr PJSIP split \n
define PJSIP_DEV ECMDDevice
attr PJSIP_DEV IODev PJSIP
attr PJSIP_DEV class PJSIPclass
attr PJSIP_DEV room sip
define NOTIFY_PJSIP notify PJSIP_DEV:FromNumber:.* {\
  Log 2, "$EVENT";;;;\
  my @s = (411529,60456116,737727686);;;;\
  if ($s[$EVTPART1]) {\
  Log 1, "Accepted: $EVTPART1";;;;  \
  } else {\
  Log 1, "Declined: $EVTPART1";;;;\
  };;;;\
  fhem("set DUMMY_ONOFF go");;;;\
}
attr NOTIFY_PJSIP room lab,sip
attr NOTIFY_PJSIP verbose 1
define NOTIFY_EQUITHERM notify MYSENSOR_BALKON:temperature.*|PID_obyvak:desired.*|CENTRALA:sum_req.* {\
no warnings 'redefine';;;;\
#use List::Util qw[min max];;;;\
sub my_max ($$) { $_[$_[0] < $_[1]] }\
	\
### readings\
my $t_e = ReadingsVal("MYSENSOR_BALKON", "temperature", -20);;;;\
fhem("setreading $SELF t_e $t_e");;;;\
\
my $t_i = ReadingsVal("PID_obyvak", "desired", 20);;;;\
fhem("setreading $SELF t_i $t_i");;;;\
\
my $P = ReadingsVal("CENTRALA", "sum_req", 0);;;;\
fhem("setreading $SELF PID $P");;;;\
\
### EQT params\
my $t_e_M = AttrVal("$SELF","p_t_e_M",-12.0);;;; # minimal external temp\
my $t_w1_M= AttrVal("$SELF","p_t_w1_M",60);;;; # boiler maximal output temp\
my $t_w1_min=AttrVal("$SELF","p_t_w1_min",35);;;; # boiler minimal output temp\
my $t_w2_M= AttrVal("$SELF","p_t_w2_M",50);;;; # boiler maximal return temp\
my $n = AttrVal("$SELF","p_n",1.3);;;; # radiator constant\
\
### PID correction\
my $K= AttrVal("$SELF","p_pid_K",0.03);;;;\
my $s= AttrVal("$SELF","p_pid_s",0);;;;\
my $q= AttrVal("$SELF","p_pid_q",25);;;;\
\
### computations\
# http://vytapeni.tzb-info.cz/tabulky-a-vypocty/50-ekvitermni-krivky\
\
my $X  = ($t_e-$t_i)/($t_e_M-$t_i);;;;\
#my $XN =  ($X)^(1/$n);;;;\
my $XN = 0;;;;\
if ($X>0) {\
	$XN = exp(log($X)/$n);;;; \
	Log 3, sprintf("$SELF: XN=exp(log($X)/$n)=$XN");;;;\
} else {\
	# $XN = ($X)^(1/$n);;;; # complex number\
	# Log 3, sprintf("$SELF: XN=$X^(1/$n)=$XN");;;;\
	$XN = 0;;;;\
	Log 3, sprintf("$SELF: ($X)^(1/$n) := $XN");;;;\
}\
\
my $DT = ($t_w1_M - $t_w2_M) * ($X);;;;\
fhem("setreading $SELF DT $DT");;;;\
	\
sub t_w_med {\
	### $t_i + $_[0]*(($t_w1_M + $t_w2_M)/2 -$t_i) * ($X)^(1/$n);;;;\
	$t_i + $_[0]*(($t_w1_M + $t_w2_M)/2 -$t_i) * $XN;;;;\
}\
\
sub t_w1 {\
	t_w_med($_[0]) + 1/2*$DT;;;;\
}\
\
# non-modified t_w1 (C=1)\
my $t_w1_1 =  t_w1(1);;;; \
\
# PID-modified t_w1 (according to C=$K*($P-$q))\
my $t_w1_PID =\
	 my_max(\
	   t_w1($K*($P-$q)) + $s*($P-$q),\
	   t_w1(1) + $s*($P-$q));;;;\
\
Log 3, "$SELF: K=$K, P=$P, q=$q, s=$s, K*(P-q)=$K*($P-$q), s*(P-q)=$s*($P-$q)";;;;\
Log 3, sprintf("$SELF: K=%f, P=%f, q=%f, s=%f, K*(P-q)=%f, s*(P-q)=%f", $K, $P, $q, $s, $K*($P-$q), $s*($P-$q));;;;\
Log 3, sprintf("$SELF: t_w1(%f)=%f, t_w1(1)=%f", $K*($P-$q), t_w1($K*($P-$q)), t_w1(1));;;;\
Log 2, t_w_med(1);;;;\
# correction to minimal media temp t_w1_min\
my $t_w1_PID_M  = \
	 my_max(\
	   $t_w1_PID,  \
	   $t_w1_min);;;;\
# round	   \
$t_w1_1     = sprintf "%.1f", $t_w1_1;;;; \
$t_w1_PID   = sprintf "%.1f", $t_w1_PID;;;;\
$t_w1_PID_M = sprintf "%.1f", $t_w1_PID_M;;;;\
\
fhem("setreading $SELF t_w1_1   $t_w1_1");;;;\
fhem("setreading $SELF t_w1_PID $t_w1_PID");;;;\
fhem("setreading $SELF t_w1_PID_M $t_w1_PID_M");;;;\
\
Log 1, "$SELF: t_w1_1=$t_w1_1 t_w1_PID=$t_w1_PID t_w1_PID_M=$t_w1_PID_M";;;;\
	\
fhem("setstate $SELF $t_w1_PID_M");;;;\
$t_w1_PID_M;;;;\
}
attr NOTIFY_EQUITHERM userattr p_t_e_M p_t_w1_M p_t_w1_min p_t_w2_M p_n p_pid_K p_pid_s p_pid_q
attr NOTIFY_EQUITHERM group centrala
attr NOTIFY_EQUITHERM p_n 1.3
attr NOTIFY_EQUITHERM p_pid_K 0.03
attr NOTIFY_EQUITHERM p_pid_q 25
attr NOTIFY_EQUITHERM p_pid_s 0
attr NOTIFY_EQUITHERM p_t_e_M -20
attr NOTIFY_EQUITHERM p_t_w1_M 65
attr NOTIFY_EQUITHERM p_t_w1_min 45
attr NOTIFY_EQUITHERM p_t_w2_M 52
attr NOTIFY_EQUITHERM room centrala,lab
attr NOTIFY_EQUITHERM verbose 1
define EQUITHERM_LOG FileLog ./log/equitherm-%Y-%m.log NOTIFY_EQUITHERM:.*
define SVG_EQUITHERM_LOG_1 SVG EQUITHERM_LOG:SVG_EQUITHERM_LOG_1:CURRENT
attr SVG_EQUITHERM_LOG_1 room centrala,lab
define Marantz DENON_AVR 192.168.11.33
attr Marantz room lab
attr Marantz webCmd toggle:on:off:statusRequest
define MYSENSOR_OKNO MYSENSORS_DEVICE 101
attr MYSENSOR_OKNO IODev MS_GW1
attr MYSENSOR_OKNO alias Okno
attr MYSENSOR_OKNO group Teploměr
attr MYSENSOR_OKNO mapReading_id3 3 id
attr MYSENSOR_OKNO mapReading_temperature 3 temperature
attr MYSENSOR_OKNO mapReading_value1 0 value1
attr MYSENSOR_OKNO mapReading_value2 0 value2
attr MYSENSOR_OKNO mapReading_value3 0 value3
attr MYSENSOR_OKNO mapReading_value4 0 value4
attr MYSENSOR_OKNO mapReading_value5 0 value5
attr MYSENSOR_OKNO mapReading_voltage 0 voltage
attr MYSENSOR_OKNO mode node
attr MYSENSOR_OKNO room Balkón,centrala,mysensors,teploty,domov
attr MYSENSOR_OKNO setReading_value1 1
attr MYSENSOR_OKNO setReading_value2 1
attr MYSENSOR_OKNO setReading_value3 1
attr MYSENSOR_OKNO setReading_value4 1
attr MYSENSOR_OKNO setReading_value5 1
attr MYSENSOR_OKNO stateFormat temperature °C
attr MYSENSOR_OKNO version 1.5.4

define SVG_MYSENSORS_LOG_4 SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_4:CURRENT
define SVG_MYSENSORS_LOG_5 SVG MYSENSORS_LOG:SVG_MYSENSORS_LOG_5:CURRENT
attr SVG_MYSENSORS_LOG_5 room lab,mysensors,teploty
define NOTIFY_TEMP_EXT notify MYSENSOR_BALKON:temperature|MYSENSOR_OKNO:temperature \
{\
no warnings 'redefine';;;;\
#use List::Util qw[min max];;;;\
sub my_max ($$) { $_[$_[0] < $_[1]] }\
sub my_min ($$) { $_[$_[0] > $_[1]] }\
\
my $t_balkon = ReadingsVal("MYSENSOR_BALKON", "temperature", 128);;;;\
my $t_okno   = ReadingsVal("MYSENSOR_OKNO", "temperature", 128);;;;\
my $t_min = my_min ($t_balkon, $t_okno);;;;\
my $t_max = my_max ($t_balkon, $t_okno);;;;\
\
fhem ("setreading $SELF temperature_min $t_min");;;;\
fhem ("setreading $SELF temperature_max $t_max");;;;\
\
fhem ("setstate $SELF $t_min");;;;\
\
$t_min;;;;\
\
}
attr NOTIFY_TEMP_EXT alias Venku
attr NOTIFY_TEMP_EXT group Teploměr
attr NOTIFY_TEMP_EXT room Balkón,Miki,daleko,centrala,teploty,domov
attr NOTIFY_TEMP_EXT sortby -1
attr NOTIFY_TEMP_EXT userReadings temperature_min,temperature_max
define DUMMY_TEMP_EXT dummy
attr DUMMY_TEMP_EXT alias Venku
attr DUMMY_TEMP_EXT group Teploměr
attr DUMMY_TEMP_EXT readingList koko
attr DUMMY_TEMP_EXT room Balkón,Miki,centrala,daleko,domov
attr DUMMY_TEMP_EXT setList bobo
attr DUMMY_TEMP_EXT sortby -1
attr DUMMY_TEMP_EXT stateFormat temp °C
attr DUMMY_TEMP_EXT userReadings balkon { ReadingsVal("MYSENSOR_BALKON","temperature",128);;;;},\
okno { ReadingsVal("MYSENSOR_OKNO","temperature",128);;;;},\
temp {\
    if (ReadingsVal("MYSENSOR_BALKON","temperature",128) < ReadingsVal("MYSENSOR_OKNO","temperature",128))\
    {\
         ReadingsVal("MYSENSOR_BALKON","temperature",128);;;;\
    } \
    else \
    { \
          ReadingsVal("MYSENSOR_OKNO","temperature",128);;;;\
    }\
}



#attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL publishReading_state MYSENSOR_KOTEL/state
#attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL publishState MYSENSOR_KOTEL/state


#attr CLOUDMQTTBRIDGE_PID_obyvak publishReading_state PID_obyvak/state
define DUMMY_MOTION_ONOFF dummy
attr DUMMY_MOTION_ONOFF alias motion
attr DUMMY_MOTION_ONOFF group stav domu
attr DUMMY_MOTION_ONOFF readingList state
attr DUMMY_MOTION_ONOFF room centrala,domov,motion
attr DUMMY_MOTION_ONOFF setList state:on,off,lock_on,lock_off
attr DUMMY_MOTION_ONOFF useSetExtensions 1
attr DUMMY_MOTION_ONOFF webCmd state
define NOTIFY_MOTION_ONOFF notify DUMMY_MOTION_ONOFF:* "/opt/fhem/motion_onoff.sh  "$EVENT""
attr NOTIFY_MOTION_ONOFF room motion
define AT_STATUS_DUMMY_MOTION_ONOFF at +*00:01:00 { system("/opt/fhem/motion_onoff.sh status > ./motion_onoff.status");; }
define PRESENCE_WIFI_FATPHONE PRESENCE lan-ping 192.168.11.51 10 60
attr PRESENCE_WIFI_FATPHONE room motion
define WATCHDOG_WIFI_FATPHONE watchdog PRESENCE_WIFI_FATPHONE:absent 00:35 PRESENCE_WIFI_FATPHONE:present set DUMMY_MOTION_ONOFF on
attr WATCHDOG_WIFI_FATPHONE autoRestart 1
attr WATCHDOG_WIFI_FATPHONE regexp1WontReactivate 1
attr WATCHDOG_WIFI_FATPHONE room motion
define DOIF_FATPHONE_PRESENT DOIF ([PRESENCE_WIFI_FATPHONE:"present"]) (set DUMMY_MOTION_ONOFF off)
attr DOIF_FATPHONE_PRESENT room motion
define HISTORY_PRESENCE_WIFI_FATPHONE readingsHistory PRESENCE_WIFI_FATPHONE:presence
attr HISTORY_PRESENCE_WIFI_FATPHONE room motion
attr HISTORY_PRESENCE_WIFI_FATPHONE rows 50
define PRESENCE_WIFI_MIPHONE PRESENCE lan-ping 192.168.10.54 5 60
attr PRESENCE_WIFI_MIPHONE room motion
define HISTORY_PRESENCE_WIFI_MIPHONE readingsHistory PRESENCE_WIFI_MIPHONE:presence
attr HISTORY_PRESENCE_WIFI_MIPHONE room motion
attr HISTORY_PRESENCE_WIFI_MIPHONE rows 100
define WATCHDOG_WIFI_MIPHONE watchdog PRESENCE_WIFI_MIPHONE:absent 00:15 PRESENCE_WIFI_MIPHONE:present set DUMMY_MIDOMA 0
attr WATCHDOG_WIFI_MIPHONE autoRestart 1
attr WATCHDOG_WIFI_MIPHONE regexp1WontReactivate 1
attr WATCHDOG_WIFI_MIPHONE room motion
define DUMMY_MIDOMA dummy
attr DUMMY_MIDOMA room motion
attr DUMMY_MIDOMA setList state:1,0
attr DUMMY_MIDOMA webCmd state
define DOIF_MIPHONE_PRESENT DOIF ([PRESENCE_WIFI_MIPHONE:"present"]) (set DUMMY_MIDOMA 1)
attr DOIF_MIPHONE_PRESENT room motion
define Uploader_PRESENCE_WIFI_MIPHONE notify PRESENCE_WIFI_MIPHONE:presence:present "./upload_data_param 255 PRESENCE_WIFI_MIPHONE 1"
attr Uploader_PRESENCE_WIFI_MIPHONE room motion
define Uploader_PRESENCE_WIFI_FATPHONE notify PRESENCE_WIFI_FATPHONE:presence:present "./upload_data_param 255 PRESENCE_WIFI_FATPHONE 1"
attr Uploader_PRESENCE_WIFI_FATPHONE room motion
define Uploader_DUMMY_MIDOMA notify DUMMY_MIDOMA "./upload_data_param 255 DUMMY_MIDOMA $EVTPART0"
attr Uploader_DUMMY_MIDOMA room motion



define CLOUDMQTT MQTT m21.cloudmqtt.com:16285
attr CLOUDMQTT room mqtt
attr CLOUDMQTT verbose 3

define CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY MQTT_BRIDGE PRESENTHOME_DUMMY
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY IODev CLOUDMQTT
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY publishState PRESENTHOME_DUMMY/current
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY qos 1
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY retain 1
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY room mqtt
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY stateFormat transmission-state
attr CLOUDMQTTBRIDGE_PRESENTHOME_DUMMY subscribeSet PRESENTHOME_DUMMY/set

define CLOUDMQTTBRIDGE_MYSENSOR_KOTEL MQTT_BRIDGE MYSENSOR_KOTEL
attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL IODev CLOUDMQTT
attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL publishReading_percentage251 MYSENSOR_KOTEL/setpoint
attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL retain 1
attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL room mqtt
attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL stateFormat transmission-state
#attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL publishReading_state MYSENSOR_KOTEL/state
#attr CLOUDMQTTBRIDGE_MYSENSOR_KOTEL publishState MYSENSOR_KOTEL/state


define CLOUDMQTTBRIDGE_PID_obyvak MQTT_BRIDGE PID_obyvak
attr CLOUDMQTTBRIDGE_PID_obyvak IODev CLOUDMQTT
attr CLOUDMQTTBRIDGE_PID_obyvak publishReading_actuation PID_obyvak/actuation
attr CLOUDMQTTBRIDGE_PID_obyvak publishReading_desired PID_obyvak/desired
attr CLOUDMQTTBRIDGE_PID_obyvak publishReading_measured PID_obyvak/measured
attr CLOUDMQTTBRIDGE_PID_obyvak publishState PID_obyvak/state
attr CLOUDMQTTBRIDGE_PID_obyvak retain 1
attr CLOUDMQTTBRIDGE_PID_obyvak room mqtt
attr CLOUDMQTTBRIDGE_PID_obyvak stateFormat transmission-state
attr CLOUDMQTTBRIDGE_PID_obyvak subscribeSet_desired PID_obyvak/set
#attr CLOUDMQTTBRIDGE_PID_obyvak publishReading_state PID_obyvak/state

define CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF MQTT_BRIDGE DUMMY_MOTION_ONOFF
attr CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF IODev CLOUDMQTT
attr CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF publishState DUMMY_MOTION_ONOFF/current
attr CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF room motion,mqtt
attr CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF stateFormat transmission-state
attr CLOUDMQTTBRIDGE_DUMMY_MOTION_ONOFF subscribeSet DUMMY_MOTION_ONOFF/set
define MYSENSOR_0 MYSENSORS_DEVICE 0
attr MYSENSOR_0 IODev MS_GW2
attr MYSENSOR_0 mode repeater
attr MYSENSOR_0 version 2.3.1
define avg_temp average .*:temperature.*
attr avg_temp room teploty
define WEBlocal8088 FHEMWEB 8088 global
attr WEBlocal8088 defaultRoom domov
attr WEBlocal8088 room web
attr WEBlocal8088 stylesheetPrefix touchpad
